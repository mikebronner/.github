name: Sync Issues & PRs to Project

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:      # Manual trigger anytime

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Sync open issues and PRs to project
        env:
          GH_TOKEN: ${{ secrets.HOBBES }}
          PROJECT_ID: PVT_kwHOABtUSs4A1sl-
          OWNER: mikebronner
          BATCH_SIZE: 20
        run: |
          set +e

          echo "üîç Fetching all open issues and PRs..."

          # Step 1: Collect ALL node IDs across all pages first
          NODE_IDS=()
          PAGE=1

          while true; do
            RESPONSE=$(gh api "search/issues?q=is:open+owner:${OWNER}&per_page=100&page=${PAGE}" 2>&1)
            if [ $? -ne 0 ]; then
              echo "‚ùå Search API failed: $RESPONSE"
              exit 1
            fi

            COUNT=$(echo "$RESPONSE" | jq '.items | length')
            [ "$COUNT" -eq 0 ] && break

            echo "üìÑ Page $PAGE: $COUNT items"

            for i in $(seq 0 $((COUNT - 1))); do
              NODE_IDS+=("$(echo "$RESPONSE" | jq -r ".items[$i].node_id")")
            done

            [ "$COUNT" -lt 100 ] && break
            PAGE=$((PAGE + 1))
          done

          TOTAL=${#NODE_IDS[@]}
          echo ""
          echo "üìä Total items to sync: $TOTAL"
          echo "üöÄ Processing in batches of $BATCH_SIZE..."
          echo ""

          # Step 2: Send batched GraphQL mutations
          ADDED=0
          SKIPPED=0
          FAILED=0

          for ((start=0; start<TOTAL; start+=BATCH_SIZE)); do
            end=$((start + BATCH_SIZE - 1))
            [ $end -ge $TOTAL ] && end=$((TOTAL - 1))
            BATCH_COUNT=$((end - start + 1))

            echo "‚ö° Batch $((start / BATCH_SIZE + 1)): items $((start + 1))‚Äì$((end + 1))"

            # Build batched mutation (one request, multiple aliases)
            MUTATION="mutation {"
            for ((i=start; i<=end; i++)); do
              MUTATION+=" add_${i}: addProjectV2ItemById(input: { projectId: \"${PROJECT_ID}\", contentId: \"${NODE_IDS[$i]}\" }) { item { id } }"
            done
            MUTATION+=" }"

            RESULT=$(gh api graphql -f query="$MUTATION" 2>&1)

            if echo "$RESULT" | grep -q '"errors"'; then
              # Check if it's all FORBIDDEN or partial failures
              ERR_COUNT=$(echo "$RESULT" | jq '.errors | length' 2>/dev/null || echo 0)
              SUCCESS_COUNT=$(echo "$RESULT" | jq '[.data | to_entries[] | select(.value.item != null)] | length' 2>/dev/null || echo 0)
              ALREADY_COUNT=$(echo "$RESULT" | jq '[.errors[] | select(.message | test("already|exists"; "i"))] | length' 2>/dev/null || echo 0)

              ADDED=$((ADDED + SUCCESS_COUNT))
              SKIPPED=$((SKIPPED + ALREADY_COUNT))
              FAILED=$((FAILED + ERR_COUNT - ALREADY_COUNT))

              echo "  ‚úÖ $SUCCESS_COUNT added | ‚è≠Ô∏è  $ALREADY_COUNT existing | ‚ùå $((ERR_COUNT - ALREADY_COUNT)) failed"
            else
              # All succeeded
              ADDED=$((ADDED + BATCH_COUNT))
              echo "  ‚úÖ $BATCH_COUNT added"
            fi
          done

          echo ""
          echo "‚úÖ Done! Added: $ADDED | Already in project: $SKIPPED | Failed: $FAILED"
          [ $((ADDED + SKIPPED)) -eq 0 ] && [ $FAILED -gt 0 ] && exit 1
          exit 0
