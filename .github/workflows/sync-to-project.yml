name: Sync Issues & PRs to Project

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:      # Manual trigger anytime

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Generate App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Sync open issues and PRs to project
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          PROJECT_ID: PVT_kwHOABtUSs4A1sl-
          OWNER: mikebronner
        run: |
          set +e  # Don't exit on individual item failures

          echo "üîç Fetching all open issues and PRs..."
          ADDED=0
          SKIPPED=0
          FAILED=0
          PAGE=1

          while true; do
            RESPONSE=$(gh api "search/issues?q=is:open+owner:${OWNER}&per_page=100&page=${PAGE}" 2>&1)
            if [ $? -ne 0 ]; then
              echo "‚ùå Search API failed: $RESPONSE"
              exit 1
            fi

            COUNT=$(echo "$RESPONSE" | jq '.items | length')
            [ "$COUNT" -eq 0 ] && break

            echo "üìÑ Page $PAGE: $COUNT items"

            # Process each item
            for i in $(seq 0 $((COUNT - 1))); do
              NODE_ID=$(echo "$RESPONSE" | jq -r ".items[$i].node_id")
              TITLE=$(echo "$RESPONSE" | jq -r ".items[$i].title" | cut -c1-60)

              RESULT=$(gh api graphql \
                -f query='mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) {
                    item { id }
                  }
                }' \
                -f projectId="$PROJECT_ID" \
                -f contentId="$NODE_ID" 2>&1)

              if echo "$RESULT" | grep -q '"id"'; then
                ADDED=$((ADDED + 1))
                echo "  ‚úÖ $TITLE"
              elif echo "$RESULT" | grep -qi "already exists\|already added"; then
                SKIPPED=$((SKIPPED + 1))
              else
                FAILED=$((FAILED + 1))
                echo "  ‚ùå $TITLE"
                echo "     $RESULT" | head -2
              fi
            done

            [ "$COUNT" -lt 100 ] && break
            PAGE=$((PAGE + 1))
          done

          echo ""
          echo "‚úÖ Done! Added: $ADDED | Already in project: $SKIPPED | Failed: $FAILED"

          # Fail the workflow if nothing worked at all
          [ $((ADDED + SKIPPED)) -eq 0 ] && [ $FAILED -gt 0 ] && exit 1
          exit 0
